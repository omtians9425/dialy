# 7/4

## Kotest と StateFlow

[Kotest](https://github.com/kotest/kotest) の Behavior spec で StateFlow を持った ViewModel の test を書く

テストスレッドにおける Dispatchers.Main を差し替えるために以下のようなクラスを(JUnit で `TestWatcher` を継承して作っていたやつを Kotest 向けに)作る。
`AutoScan` アノテーションによりモジュール全体に適用される

```kt
@OptIn(ExperimentalCoroutinesApi::class)
@AutoScan
class KotestMainDispatcherListener : BeforeSpecListener, AfterSpecListener {

    override suspend fun beforeSpec(spec: Spec) {
        Dispatchers.setMain(UnconfinedTestDispatcher())
        spec.coroutineTestScope = true // runTest(https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-test/kotlinx.coroutines.test/run-test.html) を使用する
    }

    override suspend fun afterSpec(spec: Spec) {
        Dispatchers.resetMain()
    }
}
```

テストを書く

```kt
class SampleViewModelTest : BehaviorSpec({

    Given("SampleViewModel") {

        When("Data is loaded") {
            val state = CharacterSelectionViewModel()
                .state
                .first()

            Then("State has loaded character id") {
                state shouldBe SampleViewModel.State(
                    ...
                )
            }
        }
    }
}
```

Ref

- https://qiita.com/mangano-ito/items/fa94ff6cef4256f9e400

# 7/5

上と前後する内容だが (UnconfinedTestDispatcher, runTest 辺り)

## [Testing Kotlin flows on Android](https://developer.android.com/kotlin/flow/test)

### 一つずつ値を流しては assert したいような場合

Fake クラスに emit メソッドを用意しておくと便利

```kt
class Repository(private val dataSource: DataSource) {
    fun scores(): Flow<Int> {
        return dataSource.counts().map { it * 10 }
    }
}

class FakeDataSource : DataSource {
    private val flow = MutableSharedFlow<Int>()
    suspend fun emit(value: Int) = flow.emit(value)
    override fun counts(): Flow<Int> = flow
}
```

テストは以下のように書ける

```kt
@Test
fun continuouslyCollect() = runTest {
    val dataSource = FakeDataSource()
    val repository = Repository(dataSource)

    val values = mutableListOf<Int>()
    val collectJob = launch(UnconfinedTestDispatcher()) {
        repository.scores().toList(values)
    }

    dataSource.emit(1)
    assertEquals(10, values[0]) // Assert on the list contents

    dataSource.emit(2)
    dataSource.emit(3)
    assertEquals(30, values[2])

    assertEquals(3, values.size) // Assert the number of items collected

    collectJob.cancel()
}
```

- 明示的に Job を cancel しないと toList が終わらない
- `UnconfinedTestDispatcher` により、launch してすぐに値が取得可能になるため、emit しては assert が実現できる

[`Turbine`](https://github.com/cashapp/turbine) を使うともう少しシュッとかける

```kt
@Test
fun usingTurbine() = runTest {
    val dataSource = FakeDataSource()
    val repository = Repository(dataSource)

    repository.scores().test {
        // Make calls that will trigger value changes only within test{}
        dataSource.emit(1)
        assertEquals(10, awaitItem())

        dataSource.emit(2)
        awaitItem() // Ignore items if needed, can also use skip(n)

        dataSource.emit(3)
        assertEquals(30, awaitItem())
    }
}
```

### StateFlow のテスト

- 基本的に値は conflated されるので中間値を読むことは難しいが、Turbine を使うとできるっぽい。StateFlow でもたまに中間値をテストしたくなることはあるので、オプションとしては知っておいた方が良さそう。
- 大抵のケースでは `.value` を直接読んでテストする
- `stateIn` で実装している場合は consumer がいないと値が流れてこないのでテストが失敗する。上でやったように `UnconfinedTestDispatcher` を使ってやると良い:

```kt
@Test
fun testLazilySharingViewModel() = runTest {
    val fakeRepository = HotFakeRepository()
    val viewModel = MyViewModelWithStateIn(fakeRepository)

    // Create an empty collector for the StateFlow
    val collectJob = launch(UnconfinedTestDispatcher()) { viewModel.score.collect() }

    assertEquals(0, viewModel.score.value) // Can assert initial value

    // Trigger-assert like before
    fakeRepository.emit(1)
    assertEquals(1, viewModel.score.value)

    fakeRepository.emit(2)
    fakeRepository.emit(3)
    assertEquals(3, viewModel.score.value)

    // Cancel the collecting job at the end of the test
    collectJob.cancel()
}
```

## Coroutines 1.6 test API

- [Migrating to the new coroutines 1.6 test APIs](https://medium.com/androiddevelopers/migrating-to-the-new-coroutines-1-6-test-apis-b99f7fc47774)
